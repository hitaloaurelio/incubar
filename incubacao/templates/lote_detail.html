{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lote.nome }}{% endblock %}


{% block botao %}      

        <li class="nav-item"><a class="nav-link" href="{% url 'incubacao:lote_lista' %}">Listagem</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'incubacao:lote_criar' %}">Novo Lote</a></li>
      
{% endblock %}


{% block content %}


{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }}">{{ m }}</div>
  {% endfor %}
{% endif %}


<div class="card p-3 shadow-sm">
  <!-- Container flexível: coluna em telas pequenas, linha em telas grandes -->
  <div class="d-flex flex-column flex-md-row align-items-center">

    <!-- Gráfico à esquerda -->
    <div class="flex-shrink-0 mb-2 mb-md-0" style="width:150px; height:150px;">
        <canvas id="chart-lote-{{ lote.pk }}"></canvas>
    </div>

    <!-- Informações à direita -->
    <div class="ms-md-2 text-center text-md-start">
        <p class="h5 mb-2">{{ lote.nome }}</p>
        <p class="text-muted mb-2">{{ lote.get_tipo_ovos_display }} • {{ lote.dias_incubacao }} dias</p>
        <p class="text-muted mb-2">
            Início: {{ lote.inicio_incubacao|date:'D, d M Y H:i' }} <br>
            Fim previsto: {{ lote.fim_previsto|date:'D, d M Y H:i' }}<br>
            {{ lote.dia_atual }} de {{ lote.dias_incubacao }} dias
        </p>
    </div>
  </div>

 
  <!-- Botões de ação -->
  <div class="text-center mt-0">
    

    {% if request.user.tipo != "FREE" %}
      <a href="{% url 'incubacao:lote_editar' lote.pk %}" class="btn btn-primary btn-sm me-2">Editar</a>
    {% endif %}

    <a href="{% url 'incubacao:lote_deletar' lote.pk %}" class="btn btn-danger btn-sm">Deletar</a>

    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalAnotacao">
      Add Anotações
    </button>
  </div>
</div>

<div class=" p-2">
  <h4>Anotações</h4>
</div>


<div class="list-group">
  {% for anotacao in lote.anotacoes.all %}
  <div class="list-group-item list-group-item-action" >
      <div class="d-flex justify-content-between align-items-center">
        {{ anotacao.texto }} - {{ anotacao.criado_em|date:"d/m/Y H:i" }}

         <!-- Container flexível para os botões -->
         <div class="d-flex gap-2">
        <!-- Botão que abre o modal específico da anotação -->
        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalDeletar{{ anotacao.id }}">
          Deletar 
        </button>

        

        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalEditar{{ anotacao.id }}">
          Editar
        </button>
      </div>

      </div>
  </div>


<!-- Modal de confirmação -->
<div class="modal fade" id="modalDeletar{{ anotacao.id }}" tabindex="-1" aria-labelledby="modalDeletarLabel{{ anotacao.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalDeletarLabel{{ anotacao.id }}">Confirmar Exclusão</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir esta anotação?  
        <p class="mt-2"><em>"{{ anotacao.texto }} "</em></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <form method="post" action="{% url 'incubacao:anotacao_deletar' anotacao.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
        </form>
      </div>
    </div>
  </div>
</div>



 <!-- Modal de Edição -->
 <div class="modal fade" id="modalEditar{{ anotacao.id }}" tabindex="-1" aria-labelledby="modalEditarLabel{{ anotacao.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'incubacao:anotacao_editar' anotacao.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarLabel{{ anotacao.id }}">Editar Anotação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <textarea name="texto" class="form-control" rows="3">{{ anotacao.texto }}</textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar alterações</button>
        </div>
      </form>
    </div>
  </div>
</div>

  {% empty %}
      <li>Sem anotações ainda.</li>
  {% endfor %}

</div>


<!-- Modal -->
<div class="modal fade" id="modalAnotacao" tabindex="-1" aria-labelledby="modalAnotacaoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'incubacao:adicionar_anotacao' lote.pk %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalAnotacaoLabel">Adicionar Anotação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <textarea name="texto" class="form-control" rows="4" placeholder="Digite sua anotação..." required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>





<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const ctx = document.getElementById("chart-lote-{{ lote.pk }}");

  if (ctx) {
    const prog = {{ lote.progresso_percent }};
    const rest = 100 - prog;

    let color = '#28a745';
    if (prog >= 50 && prog < 75) color = '#ffc107';
    else if (prog >= 75) color = '#dc3545';

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Progresso', 'Restante'],
        datasets: [{
          data: [prog, rest],
          backgroundColor: [color, '#e0e0e0'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: '70%',
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        animation: false
      },
      plugins: [{
        id: "centerImage",
        afterDraw: (chart) => {
          const {ctx, chartArea: {width, height}} = chart;
          const image = new Image();

          const tipo = "{{ lote.tipo_ovos|escapejs }}";

          if (tipo === 'CODORNA') image.src = "{% static 'codorna.png' %}";
          else if (tipo === 'GALINHA') image.src = "{% static 'galo.png' %}";
          else if (tipo === 'GALINHA DA ANGOLA') image.src = "{% static 'Galinha_da_angalo.png' %}";
          else if (tipo === 'PERU') image.src = "{% static 'peru.png' %}";
          else if (tipo === 'PERSONALIZADO') image.src = "{% static 'ovo_personalizado.png' %}";
          else image.src = "{% static 'galo.png' %}";

          const x = chart.chartArea.left + width / 2;
          const y = chart.chartArea.top + height / 2;

          ctx.save();
          // ajusta o tamanho da imagem proporcional ao gráfico
          const size = Math.min(width, height) * 0.5;
          ctx.drawImage(image, x - size/2, y - size/2, size, size);
          ctx.restore();
        }
      }]
    });
  }
});
</script>

{% endblock %}
